<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - –ü—Ä–æ–ó–∞—Ö–∏—Å—Ç</title>
<style>
body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f4f4f4; }
.container { width:33%; margin:auto; padding:20px; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); border-radius:8px; margin-top:20px; }
h1 { text-align:center; }
.cart-item { display:flex; justify-content:space-between; margin:15px 0; padding:10px; border-bottom:1px solid #ddd; }
.total-price { font-size:1.2em; font-weight:bold; text-align:right; margin-top:10px; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; font-weight:bold; }
.form-group input { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px; font-size: 1.1em; }
.submit-button { width:100%; padding:10px; background:#4CAF50; color:#fff; font-size:1.1em; font-weight:bold; border:none; border-radius:5px; cursor:pointer; text-decoration:none; display:inline-block; text-align:center; transition: background 0.3s; }
.submit-button:hover { background:#45a049; }
#order-header { text-align: center; margin-bottom: 15px; }
.fade-line { opacity:0; transition: opacity 2s ease; font-size:1.2em; font-weight:bold; margin-bottom: 5px; }
.fade-line.show { opacity:1; }
.toast-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display:flex; justify-content: center; align-items: center; opacity:0; visibility:hidden; transition: opacity 0.6s ease, visibility 0.6s ease; z-index:10000; }
.toast-overlay.show { opacity:1; visibility:visible; }
.toast-message { background:#4CAF50; color:#fff; padding:20px 40px; border-radius:8px; font-size:1.5em; text-align:center; font-weight:bold; opacity:0; transform: scale(0.7); transition: transform 0.6s ease, opacity 0.6s ease; }
.toast-overlay.show .toast-message { opacity:1; transform: scale(1); }
.button-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
.button-row .submit-button { flex: 1; }
.pay-button { background: #2b7cff; display: none; opacity: 0; transition: opacity 0.5s; }
.pay-button:hover { background: #1e5fcc; }
.pay-button.visible { display: inline-block; opacity: 1; }

@media(max-width:768px) {
    .container { width:90%; padding:15px; }
    h1 { font-size:1.6em; font-weight:bold; }
    .cart-item { flex-direction:column; text-align:left; }
    .total-price { font-size:1.1em; text-align:right; }
    .submit-button { font-size:1.5em; padding:8px; }
}
</style>
</head>
<body>

<div class="container">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    <h2 id="order-header">–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
    <div id="cart-items"></div>
    <div class="total-price" id="total-price"></div>

    <h2>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
    <form id="checkout-form" action="https://formspree.io/f/xrbadqqk" method="POST">
        <div class="form-group">
            <label for="name">–ü—Ä—ñ–∑–≤–∏—â–µ, –Ü–º'—è</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
            <input type="tel" id="phone" name="phone" required>
        </div>
        <div class="form-group">
            <label for="city">–ú—ñ—Å—Ç–æ</label>
            <input type="text" id="city" name="city" required>
        </div>
        <div class="form-group">
            <label for="branch">–ù–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è "–ù–æ–≤–æ—ó –ü–æ—à—Ç–∏"</label>
            <input type="tel" id="branch" name="branch" required>
        </div>
        <input type="hidden" id="cart-data" name="cart">
        <div class="button-row">
            <button type="submit" class="submit-button">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
            <button type="button" id="pay-button" class="submit-button pay-button">üí≥ –°–ø–ª–∞—Ç–∏—Ç–∏</button>
        </div>
    </form>
</div>

<div class="toast-overlay" id="toast">
    <div class="toast-message">–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ! –î—è–∫—É—î–º–æ!</div>
</div>

<audio id="cash-sound" src="sound.mp3"></audio>

<script>
// üîπ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø PORTMONE - –ó–ê–ú–Ü–ù–Ü–¢–¨ –ù–ê –°–í–û–á –î–ê–ù–Ü
const PORTMONE_CONFIG = {
    payee_id: "–í–ê–®_PAYEE_ID", // üî¥ –ó–ê–ú–Ü–ù–Ü–¢–¨ –Ω–∞ –≤–∞—à Payee ID –∑ –∫–∞–±—ñ–Ω–µ—Ç—É Portmone
    shop_order_number: "",
    bill_amount: "",
    description: "",
    success_url: window.location.origin + "/success.html",
    failure_url: window.location.origin + "/checkout.html",
    lang: "uk"
};

let cart = JSON.parse(localStorage.getItem('cart')) || [];
let finalTotal = 0;
let currentOrderNumber = "";

// === –ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ===
function getDailyOrderNumber() {
    const today = new Date().toISOString().slice(0, 10);
    let ordersData = JSON.parse(localStorage.getItem('dailyOrders') || '{}');
    if (!ordersData.date || ordersData.date !== today) {
        ordersData = { date: today, number: 0 };
    }
    ordersData.number = (ordersData.number % 99) + 1;
    localStorage.setItem('dailyOrders', JSON.stringify(ordersData));
    return ordersData.number;
}

function generateOrderNumber() {
    const orderNum = getDailyOrderNumber();
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = String(now.getFullYear()).slice(-2);
    return `${String(orderNum).padStart(2, '0')}${day}${month}${year}`;
}

// === –ó–Ω–∏–∂–∫–∞ ===
function calculateDiscount(total) {
    let discount = 0;
    if (total >= 1000 && total < 4999) discount = 3;
    else if (total >= 5000 && total < 9999) discount = 5;
    else if (total >= 10000 && total < 29999) discount = 7;
    else if (total >= 30000 && total < 59999) discount = 10;
    else if (total >= 60000 && total < 149999) discount = 12;
    else if (total >= 150000) discount = 15;
    return discount;
}

// === PORTMONE PAYMENT ===
function createPortmonePayment() {
    const paymentUrl = `https://www.portmone.com.ua/r3/uk/gateway/` +
        `?payee_id=${PORTMONE_CONFIG.payee_id}` +
        `&shop_order_number=${PORTMONE_CONFIG.shop_order_number}` +
        `&bill_amount=${PORTMONE_CONFIG.bill_amount}` +
        `&description=${encodeURIComponent(PORTMONE_CONFIG.description)}` +
        `&success_url=${PORTMONE_CONFIG.success_url}` +
        `&failure_url=${PORTMONE_CONFIG.failure_url}` +
        `&lang=${PORTMONE_CONFIG.lang}`;
    
    return paymentUrl;
}

// === –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ===
function displayOrder() {
    const orderItemsContainer = document.getElementById('cart-items');
    const totalPriceElement = document.getElementById('total-price');
    const cartDataField = document.getElementById('cart-data');

    orderItemsContainer.innerHTML = '';
    totalPriceElement.innerHTML = '';

    let total = 0;
    let cartText = "";

    cart.forEach(item => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        const itemElement = document.createElement('div');
        itemElement.classList.add('cart-item');
        itemElement.textContent = `${item.name} ‚Äî ${item.price} –≥—Ä–Ω √ó ${item.quantity} = ${subtotal} –≥—Ä–Ω`;
        orderItemsContainer.appendChild(itemElement);
        cartText += `${item.name} ‚Äî ${item.price} –≥—Ä–Ω √ó ${item.quantity} = ${subtotal} –≥—Ä–Ω\n`;
    });

    const discountPercent = calculateDiscount(total);
    const discountAmount = (total * discountPercent) / 100;
    finalTotal = total - discountAmount;

    currentOrderNumber = generateOrderNumber();
    document.getElementById('order-header').textContent = `–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ${currentOrderNumber}`;

    // –û–Ω–æ–≤–ª—é—î–º–æ config Portmone
    PORTMONE_CONFIG.shop_order_number = currentOrderNumber;
    PORTMONE_CONFIG.bill_amount = finalTotal.toFixed(2);
    PORTMONE_CONFIG.description = `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ${currentOrderNumber} - –ü—Ä–æ–ó–∞—Ö—ñ—Å—Ç`;

    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    const totalLine = document.createElement('div');
    totalLine.classList.add('fade-line', 'show');
    totalLine.textContent = `–°—É–º–∞: ${total.toFixed(2)} –≥—Ä–Ω`;
    totalLine.style.fontSize = "1.0em";
    totalLine.style.fontWeight = "bold";
    totalPriceElement.appendChild(totalLine);

    const discountColor = discountPercent > 0 ? "green" : "gray";
    const discountText = discountPercent > 0
        ? `–ó–Ω–∏–∂–∫–∞: - ${discountAmount.toFixed(2)} –≥—Ä–Ω`
        : `–ó–Ω–∏–∂–∫–∞: 0 –≥—Ä–Ω`;

    const discountLine = document.createElement('div');
    discountLine.classList.add('fade-line');
    discountLine.textContent = discountText;
    discountLine.style.color = discountColor;
    discountLine.style.fontSize = "1.0em";
    discountLine.style.fontWeight = "bold";
    totalPriceElement.appendChild(discountLine);
    setTimeout(() => discountLine.classList.add('show'), 1500);

    const finalLine = document.createElement('div');
    finalLine.classList.add('fade-line');
    finalLine.textContent = `–î–æ —Å–ø–ª–∞—Ç–∏: ${finalTotal.toFixed(2)} –≥—Ä–Ω`;
    finalLine.style.fontSize = "1.0em";
    finalLine.style.fontWeight = "bold";
    totalPriceElement.appendChild(finalLine);
    setTimeout(() => {
        finalLine.classList.add('show');
        const sound = document.getElementById('cash-sound');
        if (sound) {
            sound.volume = 0.15;
            sound.play().catch(() => {});
        }
    }, 2500);

    cartDataField.value =
        `–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${currentOrderNumber}\n` +
        cartText +
        `\n–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${total.toFixed(2)} –≥—Ä–Ω` +
        (discountPercent > 0
            ? `\n–ó–Ω–∏–∂–∫–∞ ${discountPercent}%: - ${discountAmount.toFixed(2)} –≥—Ä–Ω\n–î–æ —Å–ø–ª–∞—Ç–∏: ${finalTotal.toFixed(2)} –≥—Ä–Ω`
            : `\n–î–æ —Å–ø–ª–∞—Ç–∏: ${finalTotal.toFixed(2)} –≥—Ä–Ω`) +
        `\n\n‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç–∏: –û—á—ñ–∫—É—î—Ç—å—Å—è`;

    // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç–∏
    setTimeout(() => {
        document.getElementById('pay-button').classList.add('visible');
    }, 3000);
}

displayOrder();

// === –ö–ù–û–ü–ö–ê "–°–ü–õ–ê–¢–ò–¢–ò" ===
document.getElementById('pay-button').addEventListener('click', function (e) {
    e.preventDefault();
    
    const form = document.getElementById('checkout-form');
    const inputs = form.querySelectorAll('input[required]');
    const allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
    
    if (!allFilled) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è —Ñ–æ—Ä–º–∏!');
        return;
    }
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è success.html
    localStorage.setItem('lastOrderNumber', currentOrderNumber);
    
    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–∫–æ—é –≤ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ
    const cartDataField = document.getElementById('cart-data');
    cartDataField.value = cartDataField.value + '\n\nüí≥ –°–ü–õ–ê–ß–ï–ù–û –ö–ê–†–¢–ö–û–Æ –û–ù–õ–ê–ô–ù';
    
    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ä–º—É –Ω–∞ email
    const data = new FormData(form);
    fetch(form.action, { 
        method: form.method, 
        body: data, 
        headers: { 'Accept': 'application/json' } 
    })
    .then(response => {
        if (response.ok) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ Portmone
            const paymentUrl = createPortmonePayment();
            window.location.href = paymentUrl;
        } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
        }
    })
    .catch(() => alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º."));
});

// === –ö–ù–û–ü–ö–ê "–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò" ===
document.getElementById('checkout-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    
    fetch(form.action, { 
        method: form.method, 
        body: data, 
        headers: { 'Accept': 'application/json' } 
    })
    .then(response => {
        if (response.ok) {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => { 
                toast.classList.remove('show');
                localStorage.removeItem('cart');
                window.location.href = "index.html";
            }, 2500);
        } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
        }
    })
    .catch(() => alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º."));
});

// –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö—ñ–¥ –º—ñ–∂ –ø–æ–ª—è–º–∏
const inputs = document.querySelectorAll('#name, #phone, #city, #branch');
inputs.forEach((field, index) => {
    field.addEventListener('keydown', function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            if (index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        }
    });
});

// –ú–æ–±—ñ–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 768) {
    inputs.forEach(input => {
        input.addEventListener('focus', () => {
            document.body.style.paddingBottom = '300px';
            window.scrollTo(0, document.body.scrollHeight);
        });
        input.addEventListener('blur', () => {
            document.body.style.paddingBottom = '0';
        });
    });
}
</script>

</body>
</html>
